{% extends "base_2.html" %}

{% block content %}

    <style>
        body{background:#f7f7fb}
        .container{width:100%; margin:10px auto;padding:16px; background-color:#f1f1f1;; border-radius:10px; }
        .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin-bottom:16px}
        .muted{color:#6b7280;font-size:.9rem}
        .hstack{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
        .vstack{display:flex;gap:8px;flex-direction:column}
        .btn{border:1px solid #e5e7eb;border-radius:10px;padding:6px 10px;background:#111827;color:#fff;cursor:pointer}
        .btn.light{background:#fff;color:#111827}
        .btn.danger{background:#991b1b}
        .input, textarea{border:1px solid #e5e7eb;border-radius:10px;padding:8px;width:100%}
        .topic-title{font-weight:700;font-size:1.2rem}
        .meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap;font-size:.85rem;color:#6b7280}
        .flag{font-size:1.1rem}
        .comment{border:1px solid #f0f0f3;border-radius:10px;padding:10px;margin-top:10px}
        .reply{margin-left:24px}
        .link{color:#2563eb;text-decoration:none}
        .link:hover{text-decoration:underline}
    </style>

      <section id="authBox" style="border:1px solid #ddd; padding:12px; border-radius:10px; margin-bottom:16px;">
        <div id="authStatus" style="margin-bottom:10px;">Chargement‚Ä¶</div>

        <div id="authForms" style="display:flex; gap:18px; flex-wrap:wrap;">
          <!-- Register -->
          <div id="inscription" style="min-width:260px;">
            <h4 style="margin:0 0 8px 0;">Inscription</h4>
            <input id="regFirst" placeholder="Pr√©nom" style="width:100%; margin:4px 0;">
            <input id="regLast" placeholder="Nom" style="width:100%; margin:4px 0;">
            <input id="regEmail" placeholder="Email" style="width:100%; margin:4px 0;">
            <input id="regCity" placeholder="Ville" style="width:100%; margin:4px 0;">
            <input id="regPwd" type="password" placeholder="Mot de passe" style="width:100%; margin:4px 0;">
            <button id="btnRegister" style="margin-top:6px;">Cr√©er le compte</button>
            <div id="regMsg" style="font-size:0.9em; margin-top:6px;"></div>
          </div>

          <!-- Verify -->
          <div id="validation" style="min-width:260px;">
            <h4 style="margin:0 0 8px 0;">Valider l‚Äôemail</h4>
            <input id="verEmail" placeholder="Email" style="width:100%; margin:4px 0;">
            <input id="verCode" placeholder="Code (5 digits)" style="width:100%; margin:4px 0;">
            <button id="btnVerify" style="margin-top:6px;">Valider</button>
            <div id="verMsg" style="font-size:0.9em; margin-top:6px;"></div>
          </div>

          <!-- Login -->
          <div style="min-width:260px;">
            <h4 style="margin:0 0 8px 0;">Connexion</h4>
            <input id="logEmail" placeholder="Email" style="width:100%; margin:4px 0;">
            <input id="logPwd" type="password" placeholder="Mot de passe" style="width:100%; margin:4px 0;">
            <button id="btnLogin" style="margin-top:6px;">Se connecter</button>
            <button id="btnLogout" style="margin-top:6px; display:none;">Se d√©connecter</button>
            <div id="logMsg" style="font-size:0.9em; margin-top:6px;"></div>
          </div>
        </div>
    </section>

    <div class="sous_section">ORE MI ‚Äî Sujet</div>

    <div class="container">
      <div><a class="link" href="topics.html">‚Üê Retour aux sujets</a></div>
      <div id="topic-box" class="card vstack"></div>
      <div id="comments-box"></div>
    </div>
    
    <div id="commentLocked" style="display:none; padding:12px; border:1px dashed #aaa; border-radius:10px;">
      üîí Pour commenter, connecte-toi.
    </div>

    <script>
        const API = {
          show: id => `/api/forum/topics/${id}`,
          comment:'/api/forum/comments',
          update: id => `/api/forum/comments/${id}`,
          remove: id => `/api/forum/comments/${id}`
        };
        const params = new URLSearchParams(location.search);
        const TOPIC_ID = parseInt(params.get('id')||'0',10);


        function flagEmoji(cc){ if(!cc) return ''; cc=cc.toUpperCase(); return cc.replace(/./g,c=>String.fromCodePoint(127397+c.charCodeAt(0))); }
        function formatTime(iso){ try{ return new Date(iso).toLocaleString(); }catch{ return iso; } }
        function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[c])); }
        let GEO_CACHE=null;
        async function getGeo(){ if(GEO_CACHE) return GEO_CACHE; try{ const r=await fetch('https://ipapi.co/json/'); const j=await r.json(); GEO_CACHE={city:j.city||'',country:j.country_name||'',country_code:(j.country_code||'').toUpperCase()}; }catch(e){ GEO_CACHE={city:'',country:'',country_code:''}; } return GEO_CACHE; }
        function el(html){ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstChild; }

        let ME = null;

        async function api(path, method="GET", body=null) {
          const opts = { method, headers: {} };
          if (body) {
            opts.headers["Content-Type"] = "application/json";
            opts.body = JSON.stringify(body);
          }
          const r = await fetch(path, opts);
          const data = await r.json().catch(() => ({}));
          if (!r.ok) throw new Error(data.error || ("HTTP " + r.status));
          return data;
        }

        function lockCommenting(locked){
          const lock = document.getElementById("commentLocked");
          const box  = document.getElementById("commentBox");
          if (box)  box.style.display = locked ? "none" : "block";
          if (lock) lock.style.display = locked ? "block" : "none";
        }

        async function refreshMe(){
          const data = await api("/api/auth/me");
          ME = data.user;

          const s = document.getElementById("authStatus");
          const btnLogout = document.getElementById("btnLogout");
          const btnLogin  = document.getElementById("btnLogin");
          const regBox = document.getElementById("inscription");
          const verBox = document.getElementById("validation");

          if (!ME) {
            s.textContent = "Tu peux lire. Pour commenter/r√©pondre : inscription + validation email + connexion.";
            btnLogout.style.display = "none";
            if (btnLogin) btnLogin.style.display = "inline-block";
            if (regBox) regBox.style.display = "block";
            if (verBox) verBox.style.display = "block";
            lockCommenting(true);
            return;
          }

          s.textContent = `Connect√©: ${ME.first_name} ${ME.last_name} ‚Äî ${ME.email} ‚Äî ` +
                          (ME.is_verified ? "‚úÖ email v√©rifi√©" : "‚ö†Ô∏è email non v√©rifi√©");
          btnLogout.style.display = "inline-block";
          if (btnLogin) btnLogin.style.display = "none";

          // Connect√© => plus besoin inscription
          if (regBox) regBox.style.display = "none";
          // Si non v√©rifi√© => on garde la validation visible
          if (verBox) verBox.style.display = ME.is_verified ? "none" : "block";

          lockCommenting(!ME.is_verified);
        }

        async function loadTopic(){
          if(!TOPIC_ID){ document.getElementById('topic-box').textContent='Sujet introuvable.'; return; }
          const r = await fetch(API.show(TOPIC_ID));
          if(!r.ok){ document.getElementById('topic-box').textContent='Sujet introuvable.'; return; }
          const t = await r.json();

          // En-t√™te du sujet
          const head = el(`<div class="vstack">
              <div class="topic-title">${escapeHtml(t.title)}</div>
              <div class="meta">
                <span class="flag">${flagEmoji(t.country_code)}</span>
                <span>${escapeHtml(t.author_name)}</span>
                <span>¬∑ ${escapeHtml([t.city,t.country].filter(Boolean).join(', '))}</span>
                <span>¬∑ ${formatTime(t.created_at)}</span>
              </div>
              <div>${escapeHtml(t.body)}</div>
            </div>`);
          const box = document.getElementById('topic-box');
          box.innerHTML='';
          box.appendChild(head);

          // Formulaire commentaire (direct au sujet)
          const form = el(`<div class="vstack" id="commentBox" style="margin-top:10px">
                                <div class="hstack" style="gap:10px;flex-wrap:wrap">
                                    <input class="input name" placeholder="Nom complet" style="flex:1 1 240px"/>
                                </div>

                                <textarea class="input body" rows="3" placeholder="Commentaire..."></textarea>
                                
                                <div class="hstack">
                                    <button class="btn post">Commenter</button>
                                    <span class="muted">Merci de rester courtois et pr√©cis.</span>
                                </div>

                            </div>`);

          const nameInput = form.querySelector('.name');
if (nameInput) {
  if (ME) {
    nameInput.value = `${ME.first_name} ${ME.last_name}`.trim();
    nameInput.readOnly = true;
    nameInput.style.background = "#f2f2f2";
  } else {
    nameInput.value = "";
    nameInput.readOnly = false;
    nameInput.style.background = "";
  }
}

          form.querySelector('.post').onclick = async ()=>{
            const body = form.querySelector('.body').value.trim();
            if(!body) return alert('Commentaire requis.');
            const geo = await getGeo();

            const resp = await fetch(API.comment, {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ topic_id: TOPIC_ID, body, ...geo })
            });

            const out = await resp.json().catch(()=> ({}));
            if(!resp.ok){ alert(out.error || 'Erreur'); return; }

            await loadTopic();
          };

          box.appendChild(form);

          // Commentaires
          const commentsBox = document.getElementById('comments-box');
          commentsBox.innerHTML='';
          if(!t.comments || !t.comments.length){
            commentsBox.appendChild(el(`<div class="card muted">Aucun commentaire ‚Äî sois le premier ‚ú®</div>`));
            return;
          }
          const list = el(`<div class="card vstack"></div>`);
          const map = {};
          for(const c of t.comments){
            const node = renderComment(c);
            map[c.id] = node;
            if(c.parent_id){
              const parent = map[c.parent_id];
              if(parent){ parent.querySelector('.replies').appendChild(node); }
              else { list.appendChild(node); }
            }else{
              list.appendChild(node);
            }
          }
          commentsBox.appendChild(list);
        }

        function renderComment(c){
          
          const wrap = el(`<div class="vstack" style="border:1px solid #f0f0f3;border-radius:10px;padding:10px;margin-top:10px ${c.parent_id?'margin-left:24px;':''}"></div>`);
          const meta = el(`<div class="meta">
              <span class="flag">${flagEmoji(c.country_code)}</span>
              <span>${escapeHtml(c.author_name)}</span>
              <span>¬∑ ${escapeHtml([c.city,c.country].filter(Boolean).join(', '))}</span>
              <span>¬∑ ${formatTime(c.created_at)}</span>
            </div>`);
          const body = el(`<div>${escapeHtml(c.body)}</div>`);
          wrap.appendChild(meta); wrap.appendChild(body);

          const actions = el(`<div class="hstack"></div>`);
          const btnReply = el(`<button class="btn light">R√©pondre</button>`);
          btnReply.onclick = ()=> toggleReply();
          actions.appendChild(btnReply);

          if(own && !c.deleted){
            const btnEdit = el(`<button class="btn light">Modifier</button>`);
            const btnDel  = el(`<button class="btn danger">Supprimer</button>`);

            btnEdit.onclick = ()=> startEdit();
            btnDel.onclick = ()=> doDelete();
            actions.appendChild(btnEdit);
            actions.appendChild(btnDel);
          }
          wrap.appendChild(actions);

          const replies = el(`<div class="replies"></div>`);
          wrap.appendChild(replies);

          const replyForm = el(`<div class="vstack" style="display:none;margin-top:8px">
              <div class="hstack" style="gap:10px;flex-wrap:wrap"><input class="input rname" placeholder="Nom complet" style="flex:1 1 240px"/></div>
              <textarea class="input rbody" rows="3" placeholder="R√©ponse..."></textarea>
              <div class="hstack"><button class="btn rpost">Envoyer la r√©ponse</button></div>
            </div>`);
          wrap.appendChild(replyForm);

          async function doReply(){
            const b = replyForm.querySelector('.rbody').value.trim();
            if(!author || !b) return alert('Nom et commentaire requis.');
            const geo = await getGeo();
            const resp = await fetch(API.comment, { method:'POST', 
                                                    headers:{'Content-Type':'application/json'}, 
                                                    body: JSON.stringify({ topic_id: TOPIC_ID, parent_id: c.id, body: b, ...geo }) });
            const out = await resp.json();
            if(!resp.ok){ alert(out.error || 'Erreur'); return; }
            await loadTopic();
          }
          replyForm.querySelector('.rpost').onclick = doReply;

          function toggleReply(){ replyForm.style.display = replyForm.style.display==='none' ? 'block' : 'none'; }

          function startEdit(){
            const ta = el(`<textarea class="input" rows="3">${escapeHtml(c.body)}</textarea>`);
            const row = el(`<div class="hstack"></div>`);
            const save = el(`<button class="btn">Enregistrer</button>`);
            const cancel = el(`<button class="btn light">Annuler</button>`);
            row.appendChild(save); row.appendChild(cancel);
            wrap.replaceChild(ta, body);
            actions.style.display='none';
            wrap.insertBefore(row, replies);
            save.onclick = async ()=>{
              const resp = await fetch(API.update(c.id), {
                                  method:'PUT',
                                  headers:{'Content-Type':'application/json'},
                                  body: JSON.stringify({ body: ta.value.trim() })
                                });

              const out = await resp.json();
              if(!resp.ok){ alert(out.error || 'Erreur'); return; }
              await loadTopic();
            };
            cancel.onclick = ()=>{ actions.style.display=''; wrap.replaceChild(body, ta); row.remove(); };
          }

          async function doDelete(){
              if(!confirm('Supprimer ce commentaire ?')) return;

              const resp = await fetch(API.remove(c.id), { method:'DELETE' });
              const out = await resp.json().catch(() => ({}));

              if(!resp.ok){
                alert(out.error || `Erreur HTTP ${resp.status}`);
                return;
              }
              await loadTopic();
          }

          return wrap;
        }

        refreshMe()
            .then(loadTopic)
            .catch(() => loadTopic());

    </script>

{% endblock %}
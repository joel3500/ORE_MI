<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forum de discussion — ORE MI</title>
  <link rel="stylesheet" type="text/css" href="css/design_jardin_secret.css"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins|Sofia|Trirong|Audiowide">
  <style>
    body{background:#f7f7fb}
    .container{max-width:1000px;margin:0 auto;padding:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin-bottom:16px}
    .muted{color:#6b7280;font-size:.9rem}
    .hstack{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .vstack{display:flex;gap:8px;flex-direction:column}
    .btn{border:1px solid #e5e7eb;border-radius:10px;padding:6px 10px;background:#111827;color:#fff;cursor:pointer}
    .btn.light{background:#fff;color:#111827}
    .btn.danger{background:#991b1b}
    .input, textarea{border:1px solid #e5e7eb;border-radius:10px;padding:8px;width:100%}
    .topic-title{font-weight:600;font-size:1.1rem}
    .comment{border:1px solid #f0f0f3;border-radius:10px;padding:10px;margin-top:10px}
    .reply{margin-left:24px}
    .meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap;font-size:.85rem;color:#6b7280}
    .flag{font-size:1.1rem}
    .actions button{font-size:.8rem}
    .form-row{display:flex;gap:8px;flex-wrap:wrap}
    .form-row .half{flex:1 1 240px}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
<header>
  <div class="header-title">ORE MI — Forum de discussion</div>
</header>

<div class="container">
  <div class="card">
    <p class="sous_section">DÉMARRER UN SUJET</p>
    <div class="vstack">
      <div class="form-row">
        <input id="topic-author" class="input half" placeholder="Nom complet"/>
        <input id="topic-title" class="input half" placeholder="Titre du sujet"/>
      </div>
      <textarea id="topic-body" class="input" rows="4" placeholder="Énoncé du sujet..."></textarea>
      <div class="hstack">
        <button id="btn-create-topic" class="btn">Publier le sujet</button>
        <span class="muted">Tout le monde peut participer. Reste courtois et précis ✨</span>
      </div>
    </div>
  </div>

  <div id="topics"></div>

</div><br><br>

<footer>
  Venez visiter le site et surtout, n'oubliez pas de nous laisser vos commentaires pour pouvoir l'améliorer | Tous Droits Réservés |
</footer>

<script>
const API = {
  list:   '/api/forum/topics',
  create: '/api/forum/topics',
  comment:'/api/forum/comments',       // POST new comment/reply
  update: id => `/api/forum/comments/${id}`, // PUT body + token
  remove: id => `/api/forum/comments/${id}`  // DELETE with token
};

// local storage pour les "jetons d'édition"
const TOKENS_KEY = 'forum_edit_tokens_v1';
let tokens = {};
try { tokens = JSON.parse(localStorage.getItem(TOKENS_KEY) || '{}'); } catch(_) { tokens = {}; }
function saveTokens(){ localStorage.setItem(TOKENS_KEY, JSON.stringify(tokens)); }

function flagEmoji(cc){
  if(!cc) return '';
  cc = cc.toUpperCase();
  return cc.replace(/./g, c => String.fromCodePoint(127397 + c.charCodeAt(0)));
}
function formatTime(iso){
  try { return new Date(iso).toLocaleString(); } catch { return iso; }
}

function el(html){
  const t = document.createElement('template');
  t.innerHTML = html.trim(); return t.content.firstChild;
}

async function loadTopics(){
  const r = await fetch(API.list);
  const data = await r.json();
  const box = document.getElementById('topics');
  box.innerHTML = '';
  if(!data || !data.items || data.items.length===0){
    box.appendChild(el(`<div class="card muted">Aucun sujet pour l'instant — lance le premier !</div>`));
    return;
  }
  for(const topic of data.items){
    box.appendChild(renderTopic(topic));
  }
}

function renderTopic(t){
  const card = el(`<div class="card vstack"></div>`);
  const head = el(`<div class="vstack">
      <div class="topic-title">${escapeHtml(t.title)}</div>
      <div class="muted">${escapeHtml(t.author_name)} — ${formatTime(t.created_at)}</div>
      <div>${escapeHtml(t.body)}</div>
    </div>`);
  card.appendChild(head);

  // Formulaire commentaire
  const form = el(`<div class="vstack" style="margin-top:10px">
      <div class="form-row">
        <input class="input half name" placeholder="Nom complet"/>
      </div>
      <textarea class="input body" rows="3" placeholder="Commentaire..."></textarea>
      <div class="hstack">
        <button class="btn post">Commenter</button>
        <span class="muted">Tu peux aussi répondre à un commentaire existant.</span>
      </div>
    </div>`);
  form.querySelector('.post').onclick = async ()=>{
    const author = form.querySelector('.name').value.trim();
    const body = form.querySelector('.body').value.trim();
    if(!author || !body) return alert("Nom et commentaire requis.");
    const resp = await fetch(API.comment, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ topic_id: t.id, author_name: author, body })
    });
    const out = await resp.json();
    if(!resp.ok){ alert(out.error || 'Erreur'); return; }
    if(out.token){ tokens['c'+out.comment.id] = out.token; saveTokens(); }
    await loadTopics();
  };
  card.appendChild(form);

  // Liste des commentaires
  if(t.comments && t.comments.length){
    const list = el(`<div class="vstack"></div>`);
    const map = {}; // id -> node for nesting
    for(const c of t.comments){
      const node = renderComment(c, t.id);
      map[c.id] = node;
      if(c.parent_id){
        const parent = map[c.parent_id];
        if(parent){
          const replies = parent.querySelector('.replies');
          replies.appendChild(node);
        }else{
          list.appendChild(node);
        }
      }else{
        list.appendChild(node);
      }
    }
    card.appendChild(list);
  }
  return card;
}

function renderComment(c, topicId){
  const own = tokens['c'+c.id] ? true : false;
  const wrap = el(`<div class="comment ${c.parent_id?'reply':''} vstack"></div>`);
  const meta = el(`<div class="meta">
      <span class="flag">${flagEmoji(c.country_code)}</span>
      <span>${escapeHtml(c.author_name)}</span>
      <span class="nowrap">· ${escapeHtml(c.city || '')}</span>
      <span class="nowrap">· ${formatTime(c.created_at)}</span>
    </div>`);
  wrap.appendChild(meta);

  const content = el(`<div class="body">${escapeHtml(c.body)}</div>`);
  wrap.appendChild(content);

  // actions
  const actions = el(`<div class="actions hstack"></div>`);
  // répondre
  const btnReply = el(`<button class="btn light">Répondre</button>`);
  btnReply.onclick = ()=> toggleReplyForm();
  actions.appendChild(btnReply);

  if(own && !c.deleted){
    const btnEdit = el(`<button class="btn light">Modifier</button>`);
    const btnDel  = el(`<button class="btn danger">Supprimer</button>`);
    btnEdit.onclick = ()=> startEdit();
    btnDel.onclick  = ()=> doDelete();
    actions.appendChild(btnEdit);
    actions.appendChild(btnDel);
  }
  wrap.appendChild(actions);

  const replies = el(`<div class="replies"></div>`);
  wrap.appendChild(replies);

  // reply form (hidden by default)
  const replyForm = el(`<div class="vstack" style="display:none;margin-top:8px">
      <div class="form-row"><input class="input half rname" placeholder="Nom complet"/></div>
      <textarea class="input rbody" rows="3" placeholder="Réponse..."></textarea>
      <div class="hstack"><button class="btn rpost">Envoyer la réponse</button></div>
    </div>`);
  wrap.appendChild(replyForm);

  async function doReply(){
    const author = replyForm.querySelector('.rname').value.trim();
    const body   = replyForm.querySelector('.rbody').value.trim();
    if(!author || !body) return alert("Nom et commentaire requis.");
    const resp = await fetch(API.comment, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ topic_id: topicId, parent_id: c.id, author_name: author, body })
    });
    const out = await resp.json();
    if(!resp.ok){ alert(out.error || 'Erreur'); return; }
    if(out.token){ tokens['c'+out.comment.id] = out.token; saveTokens(); }
    await loadTopics();
  }
  replyForm.querySelector('.rpost').onclick = doReply;

  function toggleReplyForm(){
    replyForm.style.display = replyForm.style.display==='none' ? 'block' : 'none';
  }

  function startEdit(){
    const ta = el(`<textarea class="input" rows="3">${escapeHtml(c.body)}</textarea>`);
    const save = el(`<button class="btn">Enregistrer</button>`);
    const cancel = el(`<button class="btn light">Annuler</button>`);
    const row = el(`<div class="hstack"></div>`);
    row.appendChild(save); row.appendChild(cancel);

    wrap.replaceChild(ta, content);
    actions.style.display='none';
    wrap.insertBefore(row, replies);

    save.onclick = async ()=>{
      const body = ta.value.trim();
      const token = tokens['c'+c.id];
      const resp = await fetch(API.update(c.id), {
        method:'PUT', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ body, token })
      });
      const out = await resp.json();
      if(!resp.ok){ alert(out.error || 'Erreur'); return; }
      await loadTopics();
    };
    cancel.onclick = ()=> { actions.style.display=''; wrap.replaceChild(content, ta); row.remove(); };
  }

  async function doDelete(){
    if(!confirm('Supprimer ce commentaire ?')) return;
    const token = tokens['c'+c.id];
    const resp = await fetch(API.remove(c.id), {
      method:'DELETE', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ token })
    });
    const out = await resp.json();
    if(!resp.ok){ alert(out.error || 'Erreur'); return; }
    await loadTopics();
  }

  return wrap;
}

function escapeHtml(s){
  return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

// Create topic
document.getElementById('btn-create-topic').onclick = async ()=>{
  const author = document.getElementById('topic-author').value.trim();
  const title  = document.getElementById('topic-title').value.trim();
  const body   = document.getElementById('topic-body').value.trim();
  if(!author || !title || !body) return alert('Remplis nom, titre et énoncé.');
  const resp = await fetch(API.create, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ author_name: author, title, body })
  });
  const out = await resp.json();
  if(!resp.ok){ alert(out.error || 'Erreur'); return; }
  // reset
  document.getElementById('topic-author').value = '';
  document.getElementById('topic-title').value = '';
  document.getElementById('topic-body').value = '';
  await loadTopics();
};

loadTopics();
</script>
</body>
</html>
